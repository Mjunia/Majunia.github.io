<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>カイル君のぶどう狩り</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: white;
    }
    canvas {
      display: block;
      background: #87CEFA;
    }
    #ui {
      position: absolute;
      top: 10px;
      width: 100%;
      text-align: center;
    }
    button {
      font-size: 1.2em;
      padding: 5px 15px;
    }
    #scoreDisplay, #gameOverMsg {
      font-size: 1.2em;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas"></canvas>
  <div id="ui">
    <button id="startBtn">スタート</button>
    <p id="scoreDisplay" style="display:none;">スコア: 0</p>
    <p id="gameOverMsg" style="display:none; color:red; font-size:1.5em;">ゲームオーバー！</p>
    <button id="retryBtn" style="display:none;">リトライ</button>
  </div>

  <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const startBtn = document.getElementById('startBtn');
    const retryBtn = document.getElementById('retryBtn');
    const scoreDisplay = document.getElementById('scoreDisplay');
    const gameOverMsg = document.getElementById('gameOverMsg');

    let cw = window.innerWidth;
    let ch = window.innerHeight;
    canvas.width = cw;
    canvas.height = ch;

    let player, items, enemies, score, gameRunning, direction;
    let spawnInterval = 2000;
    const playerSpeed = 2;
    let playerSizeGame = { width: cw * 0.1, height: ch * 0.15 };
    let playerSizeStart = { width: cw * 0.25, height: ch * 0.4 };
    const itemSpeed = 1.0;
    const enemySpeed = 1.0;
    let itemTimer, enemyTimer, difficultyTimer;
    let inStartScreen = true;

    const bgImage = new Image();
    bgImage.src = 'haikei.png';
    const playerImg = new Image();
    playerImg.src = 'kaikun.png';
    const itemImg = new Image();
    itemImg.src = 'budou.png';
    const enemyImg = new Image();
    enemyImg.src = 'kemusi.png';
    const gameOverImg = new Image();
    gameOverImg.src = 'kairukun2.png';

    bgImage.onload = () => {
      drawStartScreen();
    };

    function drawStartScreen() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(bgImage, 0, 0, canvas.width, canvas.height);
      ctx.fillStyle = 'black';
      ctx.font = '16px Arial';
      const lines = [
        '甲斐のホテルのマスコットキャラクター「カイル君」',
        '今日は山梨のぶどう狩りに来たよ♪',
        '邪魔をする毛虫をよけてぶどうを食べよう！'
      ];
      lines.forEach((line, i) => {
        const textWidth = ctx.measureText(line).width;
        ctx.fillText(line, (canvas.width - textWidth) / 2, 100 + i * 30);
      });
      ctx.drawImage(
        playerImg,
        canvas.width - playerSizeStart.width - 20,
        canvas.height - playerSizeStart.height - 20,
        playerSizeStart.width,
        playerSizeStart.height
      );
    }

    function initGame() {
      player = {
        x: canvas.width / 2,
        y: canvas.height - playerSizeGame.height - 20,
        width: playerSizeGame.width,
        height: playerSizeGame.height
      };
      items = [];
      enemies = [];
      score = 0;
      direction = 1;
      gameRunning = true;
      inStartScreen = false;
      spawnInterval = 2000;

      scoreDisplay.textContent = 'スコア: 0';
      scoreDisplay.style.display = 'block';
      gameOverMsg.style.display = 'none';
      retryBtn.style.display = 'none';

      clearInterval(itemTimer);
      clearInterval(enemyTimer);
      clearInterval(difficultyTimer);

      itemTimer = setInterval(spawnItem, 2500);
      enemyTimer = setInterval(spawnEnemy, spawnInterval);
      difficultyTimer = setInterval(() => {
        if (spawnInterval > 800) {
          spawnInterval -= 200;
          clearInterval(enemyTimer);
          enemyTimer = setInterval(spawnEnemy, spawnInterval);
        }
      }, 8000);
    }

    function spawnItem() {
      items.push({
        x: Math.random() * (canvas.width - 30),
        y: -30,
        width: 30,
        height: 30,
        speed: itemSpeed
      });
    }

    function spawnEnemy() {
      enemies.push({
        x: Math.random() * (canvas.width - 30),
        y: -30,
        width: 30,
        height: 30,
        speed: enemySpeed
      });
    }

    function update() {
      player.x += direction * playerSpeed;
      if (player.x < 0 || player.x + player.width > canvas.width) {
        direction *= -1;
        player.x = Math.max(0, Math.min(player.x, canvas.width - player.width));
      }

      items.forEach(i => i.y += i.speed);
      items = items.filter(i => i.y < canvas.height);
      items.forEach((i, idx) => {
        if (checkCollision(player, i)) {
          score += 10;
          scoreDisplay.textContent = 'スコア: ' + score;
          items.splice(idx, 1);
        }
      });

      enemies.forEach(e => e.y += e.speed);
      enemies = enemies.filter(e => e.y < canvas.height);
      enemies.forEach(e => {
        if (checkCollision(player, e)) gameOver();
      });
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(bgImage, 0, 0, canvas.width, canvas.height);
      ctx.drawImage(playerImg, player.x, player.y, player.width, player.height);
      items.forEach(i => {
        ctx.drawImage(itemImg, i.x, i.y, i.width, i.height);
      });
      enemies.forEach(e => {
        ctx.drawImage(enemyImg, e.x, e.y, e.width, e.height);
      });
    }

    function gameLoop() {
      if (!gameRunning) return;
      update();
      draw();
      requestAnimationFrame(gameLoop);
    }

    function gameOver() {
      gameRunning = false;
      gameOverMsg.style.display = 'block';
      retryBtn.style.display = 'inline-block';
      clearInterval(itemTimer);
      clearInterval(enemyTimer);
      clearInterval(difficultyTimer);
      ctx.drawImage(gameOverImg, canvas.width / 2 - 100, canvas.height / 2 - 100, 200, 200);
    }

    function checkCollision(a, b) {
      return a.x < b.x + b.width &&
             a.x + a.width > b.x &&
             a.y < b.y + b.height &&
             a.y + a.height > b.y;
    }

    // タッチ操作で切り返し
    canvas.addEventListener('touchstart', e => {
      if (gameRunning) direction *= -1;
    });

    // PCキーボードスペースで切り返し（念のため）
    window.addEventListener('keydown', e => {
      if (e.key === ' ' && gameRunning) {
        e.preventDefault(); // スクロール防止
        direction *= -1;
      }
    });

    startBtn.addEventListener('click', () => {
      if (inStartScreen) {
        initGame();
        gameLoop();
      }
    });

    retryBtn.addEventListener('click', () => {
      initGame();
      gameLoop();
    });

    // 画面リサイズ時も再調整（任意）
    window.addEventListener('resize', () => {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    });
  </script>
</body>
</html>
