<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>カイル君のぶどう狩り</title>
  <style>
    body {
      margin: 0;
      background: white;
      text-align: center;
    }
    canvas {
      display: block;
      margin: auto;
      background: #87CEFA;
    }
    #ui {
      margin: 10px;
    }
    button {
      font-size: 1em;
      padding: 5px 10px;
      margin: 5px;
    }
    #gameOverImage {
      display: none;
      position: absolute;
      top: 30%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 200px;
    }
    #gameOverText {
      display: none;
      position: absolute;
      top: 20%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: red;
      font-size: 2em;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>カイル君のぶどう狩り</h1>
  <canvas id="gameCanvas" width="400" height="600"></canvas>

  <div id="ui">
    <input id="playerName" placeholder="名前を入力" />
    <button id="startBtn">スタート</button>
    <button id="showScoresBtn">スコア履歴表示</button>
    <button id="clearScoresBtn">スコア履歴削除</button>
    <p id="scoreDisplay" style="display:none;">スコア: 0</p>
    <button id="retryBtn" style="display:none;">リトライ</button>
  </div>

  <div id="gameOverText">ゲームオーバー！</div>
  <img id="gameOverImage" src="kairukun2.png" />

  <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const startBtn = document.getElementById('startBtn');
    const retryBtn = document.getElementById('retryBtn');
    const scoreDisplay = document.getElementById('scoreDisplay');
    const playerNameInput = document.getElementById('playerName');
    const gameOverText = document.getElementById('gameOverText');
    const gameOverImage = document.getElementById('gameOverImage');
    const showScoresBtn = document.getElementById('showScoresBtn');
    const clearScoresBtn = document.getElementById('clearScoresBtn');

    const playerImg = new Image();
    playerImg.src = 'kaikun.png';
    const itemImg = new Image();
    itemImg.src = 'budou.png';
    const enemyImg = new Image();
    enemyImg.src = 'kemusi.png';

    let player, items, enemies, score, direction, gameRunning = false;
    const playerSize = { width: 40, height: 60 };
    const objectSize = { width: 50, height: 50 };
    let spawnInterval = 2000;
    const itemSpeed = 1;
    const enemySpeed = 1;
    let itemTimer, enemyTimer, difficultyTimer;

    function initGame() {
      player = { x: 180, y: 500, width: playerSize.width, height: playerSize.height };
      items = [];
      enemies = [];
      score = 0;
      direction = 1;
      gameRunning = true;
      spawnInterval = 2000;

      scoreDisplay.textContent = 'スコア: 0';
      scoreDisplay.style.display = 'block';
      retryBtn.style.display = 'none';
      gameOverText.style.display = 'none';
      gameOverImage.style.display = 'none';
      startBtn.style.display = 'none';
      playerNameInput.style.display = 'none';
      showScoresBtn.style.display = 'none';
      clearScoresBtn.style.display = 'none';

      clearInterval(itemTimer);
      clearInterval(enemyTimer);
      clearInterval(difficultyTimer);

      itemTimer = setInterval(spawnItem, 2500);
      enemyTimer = setInterval(spawnEnemy, spawnInterval);
      difficultyTimer = setInterval(() => {
        if (spawnInterval > 800) {
          spawnInterval -= 200;
          clearInterval(enemyTimer);
          enemyTimer = setInterval(spawnEnemy, spawnInterval);
        }
      }, 8000);

      requestAnimationFrame(gameLoop);
    }

    function spawnItem() {
      items.push({
        x: Math.random() * (canvas.width - objectSize.width),
        y: -objectSize.height,
        width: objectSize.width,
        height: objectSize.height,
        speed: itemSpeed
      });
    }

    function spawnEnemy() {
      enemies.push({
        x: Math.random() * (canvas.width - objectSize.width),
        y: -objectSize.height,
        width: objectSize.width,
        height: objectSize.height,
        speed: enemySpeed
      });
    }

    function update() {
      player.x += direction * 2;
      if (player.x < 0 || player.x + player.width > canvas.width) {
        direction *= -1;
        player.x = Math.max(0, Math.min(player.x, canvas.width - player.width));
      }

      items.forEach(i => i.y += i.speed);
      items = items.filter(i => i.y < canvas.height);
      items.forEach((i, idx) => {
        if (checkCollision(player, i)) {
          score += 10;
          scoreDisplay.textContent = 'スコア: ' + score;
          items.splice(idx, 1);
        }
      });

      enemies.forEach(e => e.y += e.speed);
      enemies = enemies.filter(e => e.y < canvas.height);
      enemies.forEach(e => {
        if (checkEnemyCollision(player, e)) {
          endGame();
        }
      });
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(playerImg, player.x, player.y, player.width, player.height);
      items.forEach(i => {
        ctx.drawImage(itemImg, i.x, i.y, i.width, i.height);
      });
      enemies.forEach(e => {
        ctx.drawImage(enemyImg, e.x, e.y, e.width, e.height);
      });
    }

    function gameLoop() {
      if (!gameRunning) return;
      update();
      draw();
      requestAnimationFrame(gameLoop);
    }

    function checkCollision(a, b) {
      return a.x < b.x + b.width &&
             a.x + a.width > b.x &&
             a.y < b.y + b.height &&
             a.y + a.height > b.y;
    }

    function checkEnemyCollision(a, b) {
      // 当たり判定を緩くする（上下左右10pxの余裕）
      return a.x + 10 < b.x + b.width &&
             a.x + a.width - 10 > b.x &&
             a.y + 10 < b.y + b.height &&
             a.y + a.height - 10 > b.y;
    }

    function endGame() {
      gameRunning = false;
      clearInterval(itemTimer);
      clearInterval(enemyTimer);
      clearInterval(difficultyTimer);
      gameOverText.style.display = 'block';
      gameOverImage.style.display = 'block';
      retryBtn.style.display = 'inline-block';

      const name = playerNameInput.value || 'ななし';
      const history = JSON.parse(localStorage.getItem('scores') || '[]');
      history.push({ name, score });
      history.sort((a, b) => b.score - a.score);
      localStorage.setItem('scores', JSON.stringify(history));
    }

    window.addEventListener('keydown', e => {
      if (e.key === ' ' && gameRunning) direction *= -1;
    });

    startBtn.addEventListener('click', () => {
      if (!gameRunning) initGame();
    });

    retryBtn.addEventListener('click', () => {
      initGame();
    });

    showScoresBtn.addEventListener('click', () => {
      const history = JSON.parse(localStorage.getItem('scores') || '[]');
      const list = history.map(h => `${h.name}: ${h.score}`).join('\n');
      alert("スコア履歴:\n" + (list || "なし"));
    });

    clearScoresBtn.addEventListener('click', () => {
      if (confirm("スコア履歴をすべて削除しますか？")) {
        localStorage.removeItem('scores');
        alert("スコア履歴を削除しました");
      }
    });
  </script>
</body>
</html>
